@using Microsoft.AspNetCore.Identity
@inject UserManager<OkeanChat.Models.ApplicationUser> UserManager
@{
    ViewData["Title"] = "OkeanChat - Discord-like Chat";
}

<div class="min-h-screen bg-gray-900 flex relative">
    <!-- Mobile Menu Toggle -->
    <button id="mobileMenuToggle" class="lg:hidden fixed top-4 left-4 z-50 bg-gray-800 text-white p-2 rounded-md hover:bg-gray-700">
        <i class="fas fa-bars text-xl"></i>
    </button>
    
    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar-mobile sidebar-hidden w-64 bg-gray-800 flex flex-col fixed lg:static inset-y-0 left-0 transition-transform duration-300 z-40" style="transform: translateX(-100%);">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="~/img/logo.jpg" alt="OkeanChat Logo" class="w-10 h-10 rounded mr-3" />
                    <h1 class="text-xl font-bold text-white">OkeanChat</h1>
                </div>
                <button id="closeSidebarBtn" class="lg:hidden text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Channels -->
        <div class="flex-1 p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Channels</h2>
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <button id="addChannelBtn" class="text-gray-400 hover:text-white">
                        <i class="fas fa-plus"></i>
                    </button>
                }
            </div>
            
            <div class="space-y-1">
                @if (ViewBag.Channels != null)
                {
                    @foreach (var channel in ViewBag.Channels as List<OkeanChat.Models.Channel>)
                    {
                        <a href="@Url.Action("Chat", "Home", new { channelId = channel.Id })" 
                           class="flex items-center px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-md group">
                            <i class="fas fa-hashtag text-gray-500 mr-2 group-hover:text-gray-300"></i>
                            @channel.Name
                        </a>
                    }
                }
            </div>
        </div>

        <!-- Friends Section -->
        @if (User.Identity?.IsAuthenticated == true)
        {
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Friends</h2>
                        <span id="friendsUnreadBadge" class="ml-2 bg-red-500 text-white text-xs font-bold rounded-full px-2 py-0.5 hidden">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="addFriendBtn" class="text-gray-400 hover:text-white transition-colors" title="Add Friend">
                            <i class="fas fa-user-plus"></i>
                        </button>
                        <button id="refreshFriendsBtn" class="text-gray-400 hover:text-white transition-colors" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Friend Requests Badge -->
                <div id="friendRequestsBadge" class="mb-3 hidden">
                    <button id="friendRequestsBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded text-sm flex items-center justify-between transition-colors shadow-lg">
                        <span class="flex items-center">
                            <i class="fas fa-user-clock mr-2"></i>
                            Friend Requests
                        </span>
                        <span id="friendRequestsCount" class="bg-white text-yellow-600 rounded-full px-2 py-1 text-xs font-bold animate-pulse">0</span>
                    </button>
                </div>
                
                <!-- Search Friends -->
                <div class="mb-3">
                    <div class="flex items-center bg-gray-700 border border-gray-600 rounded overflow-hidden">
                        <div class="px-2 text-gray-400">
                            <i class="fas fa-search text-sm"></i>
                        </div>
                        <input type="text" id="searchFriendInput" 
                               class="flex-1 bg-gray-700 px-3 py-2 text-white text-sm placeholder-gray-400 focus:outline-none focus:border-blue-500 transition-colors border-0" 
                               placeholder="Search or add friends...">
                    </div>
                </div>
                
                <div id="searchResults" class="mb-3 hidden space-y-2 max-h-64 overflow-y-auto"></div>
                
                <!-- Friends List Filter -->
                <div id="friendsListFilter" class="mb-2 hidden">
                    <div class="flex items-center space-x-2 text-xs">
                        <span class="text-gray-400">Filter:</span>
                        <button class="filter-btn active-filter px-2 py-1 rounded bg-gray-700 text-white hover:bg-gray-600" data-filter="all">All</button>
                        <button class="filter-btn px-2 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600" data-filter="online">Online</button>
                    </div>
                </div>
                
                <!-- Friends List -->
                <div id="friendsList" class="space-y-1 max-h-64 overflow-y-auto">
                    <div class="text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                        <p class="text-gray-400 text-xs mt-2">Loading friends...</p>
                    </div>
                </div>
            </div>
        }

        <!-- User Info -->
        <div class="p-4 border-t border-gray-700">
            @if (User.Identity?.IsAuthenticated == true)
            {
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center overflow-hidden avatar-container avatar-bordered" style="--avatar-size: 32px;">
                        @{
                            var user = await UserManager.GetUserAsync(User);
                            if (user != null && !string.IsNullOrEmpty(user.Avatar))
                            {
                                <img id="navAvatarIndex" src="@user.Avatar" alt="@user.DisplayName" class="nav-avatar avatar-perfect-circle force-circle">
                            }
                            else
                            {
                                <span class="text-sm font-semibold text-white">@User.Identity.Name?.Substring(0, 1).ToUpper()</span>
                            }
                        }
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-white">@User.Identity.Name</p>
                        <p class="text-xs text-gray-400">Online</p>
                    </div>
                    <!-- Friend Requests Badge Icon -->
                    <div id="friendRequestsIconBadge" class="relative hidden">
                        <button id="friendRequestsIconBtn" class="relative p-2 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-gray-700">
                            <i class="fas fa-user-friends text-lg"></i>
                            <span id="friendRequestsIconCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center"></span>
                        </button>
                    </div>
                </div>
                <div class="mt-2 space-y-1">
                    <a asp-action="Profile" asp-controller="Account" class="block text-xs text-gray-400 hover:text-white">Profile</a>
                    <form asp-action="Logout" asp-controller="Account" method="post" class="inline">
                        <button type="submit" class="text-xs text-gray-400 hover:text-white">Sign Out</button>
                    </form>
                </div>
            }
            else
            {
                <div class="space-y-2">
                    <a asp-action="Login" asp-controller="Account" class="block w-full py-2 px-3 text-sm text-center bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Sign In
                    </a>
                    <a asp-action="Register" asp-controller="Account" class="block w-full py-2 px-3 text-sm text-center bg-gray-700 text-white rounded-md hover:bg-gray-600">
                        Sign Up
                    </a>
                </div>
            }
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col w-full lg:w-auto pt-16 lg:pt-0">
        <!-- Welcome Message -->
        <div class="flex-1 flex items-center justify-center bg-gray-900">
            <div class="text-center">
                <div class="w-32 h-32 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6 p-4">
                    <img src="~/img/logo.jpg" alt="OkeanChat Logo" class="w-full h-full object-contain rounded-full" />
                </div>
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <h2 class="text-3xl font-bold text-white mb-4">Welcome back, @User.Identity.Name!</h2>
                    <p class="text-gray-400 text-lg mb-8">Select a channel from the sidebar to start chatting</p>
                }
                else
                {
                    <h2 class="text-3xl font-bold text-white mb-4">Welcome to OkeanChat</h2>
                    <p class="text-gray-400 text-lg mb-8">Sign in to start chatting with your friends</p>
                }
                <div class="space-y-2">
                    @if (ViewBag.Channels != null)
                    {
                        @foreach (var channel in ViewBag.Channels as List<OkeanChat.Models.Channel>)
                        {
                            <a href="@Url.Action("Chat", "Home", new { channelId = channel.Id })" 
                               class="block px-6 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-hashtag mr-2"></i># @channel.Name
                            </a>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inline script for mobile menu - runs immediately, no jQuery dependency -->
<script>
    (function() {
        // Mobile menu functions - no dependencies
        function openSidebar() {
            var sidebar = document.getElementById('sidebar');
            var overlay = document.getElementById('mobileOverlay');
            if (sidebar && overlay) {
                sidebar.classList.remove('sidebar-hidden');
                sidebar.classList.add('sidebar-open-class');
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.webkitTransform = 'translateX(0)';
                sidebar.style.display = 'flex';
                overlay.classList.remove('hidden');
                overlay.style.display = 'block';
                document.body.classList.add('sidebar-open');
            }
        }
        
        function closeSidebar() {
            var sidebar = document.getElementById('sidebar');
            var overlay = document.getElementById('mobileOverlay');
            if (sidebar && overlay) {
                sidebar.classList.add('sidebar-hidden');
                sidebar.classList.remove('sidebar-open-class');
                sidebar.style.transform = 'translateX(-100%)';
                sidebar.style.webkitTransform = 'translateX(-100%)';
                overlay.classList.add('hidden');
                overlay.style.display = 'none';
                document.body.classList.remove('sidebar-open');
            }
        }
        
        // Setup when DOM is ready
        function setupMobileMenu() {
            var menuToggle = document.getElementById('mobileMenuToggle');
            var overlay = document.getElementById('mobileOverlay');
            var closeBtn = document.getElementById('closeSidebarBtn');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    openSidebar();
                });
            }
            
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeSidebar();
                });
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeSidebar();
                });
            }
            
            // Close sidebar on window resize to desktop
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1024) {
                    var sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.style.transform = '';
                        sidebar.style.webkitTransform = '';
                    }
                    closeSidebar();
                }
            });
            
            // Initialize sidebar state
            if (window.innerWidth >= 1024) {
                var sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.style.transform = '';
                    sidebar.style.webkitTransform = '';
                }
            }
        }
        
        // Run immediately if DOM is ready, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupMobileMenu);
        } else {
            setupMobileMenu();
        }
        
        // Make functions globally available for jQuery code
        window.openSidebar = openSidebar;
        window.closeSidebar = closeSidebar;
    })();
</script>

@if (User.Identity?.IsAuthenticated == true)
{
    <!-- Add Channel Modal -->
    <div class="modal fade" id="addChannelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-gray-800 text-white">
                <div class="modal-header border-gray-700">
                    <h5 class="modal-title">Create New Channel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addChannelForm">
                        <div class="mb-3">
                            <label for="channelName" class="form-label">Channel Name</label>
                            <input type="text" class="form-control bg-gray-700 border-gray-600 text-white" 
                                   id="channelName" name="name" placeholder="e.g., general" required>
                        </div>
                        <div class="mb-3">
                            <label for="channelDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control bg-gray-700 border-gray-600 text-white" 
                                      id="channelDescription" name="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-gray-700">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createChannelBtn">Create Channel</button>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            let currentUserId = '@((await UserManager.GetUserAsync(User))?.Id ?? "")';
            let friendSearchTimer = null;
            let chatHubConnection = null;
            let notificationHubConnection = null;

            // Request browser notification permission
            function requestNotificationPermission() {
                if ("Notification" in window && Notification.permission === "default") {
                    Notification.requestPermission();
                }
            }

            // Show browser notification
            function showBrowserNotification(title, body, icon, data) {
                if ("Notification" in window && Notification.permission === "granted") {
                    const notification = new Notification(title, {
                        body: body,
                        icon: icon || '/img/logo.jpg',
                        badge: '/img/logo.jpg',
                        tag: data?.senderId || 'message',
                        data: data
                    });

                    notification.onclick = function() {
                        window.focus();
                        if (data?.senderId) {
                            window.location.href = '/Home/Chat?channelId=1&friendId=' + data.senderId;
                        }
                        notification.close();
                    };

                    // Auto close after 5 seconds
                    setTimeout(() => notification.close(), 5000);
                }
            }

            // Initialize SignalR connection for online status
            function initializeSignalR() {
                chatHubConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/chatHub")
                    .withAutomaticReconnect()
                    .build();

                chatHubConnection.start().then(function() {
                    console.log("[Index] SignalR Connected for online status");
                }).catch(function(err) {
                    console.error("[Index] SignalR Connection Error: " + err.toString());
                });

                // Listen for friend online status updates
                chatHubConnection.on("FriendOnline", function(userId) {
                    console.log("[Index] FriendOnline:", userId);
                    updateFriendOnlineStatus(userId, true);
                });

                chatHubConnection.on("FriendOffline", function(userId) {
                    console.log("[Index] FriendOffline:", userId);
                    updateFriendOnlineStatus(userId, false);
                });

                chatHubConnection.on("FriendOnlineStatus", function(friendId, isOnline) {
                    console.log("[Index] FriendOnlineStatus:", friendId, isOnline);
                    updateFriendOnlineStatus(friendId, isOnline);
                });
            }

            // Initialize Notification Hub
            function initializeNotificationHub() {
                notificationHubConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/notificationHub")
                    .withAutomaticReconnect()
                    .build();

                notificationHubConnection.start().then(function() {
                    console.log("[Index] NotificationHub Connected");
                    
                    // Request notification permission
                    requestNotificationPermission();
                }).catch(function(err) {
                    console.error("[Index] NotificationHub Connection Error: " + err.toString());
                });

                // Listen for unread message count
                notificationHubConnection.on("ReceiveUnreadMessageCount", function(count) {
                    console.log("[Index] Unread count:", count);
                    updateUnreadBadge(count);
                });

                // Listen for new private message
                notificationHubConnection.on("NewPrivateMessage", function(data) {
                    console.log("[Index] NewPrivateMessage:", data);
                    
                    // Update unread badge
                    updateUnreadBadge(data.unreadCount);
                    
                    // Update friend item unread badge
                    updateFriendUnreadBadge(data.senderId, data.unreadCount);
                    
                    // Show browser notification if not in private chat with this friend
                    const urlParams = new URLSearchParams(window.location.search);
                    const currentFriendId = urlParams.get('friendId');
                    
                    if (currentFriendId !== data.senderId) {
                        showBrowserNotification(
                            data.senderName,
                            data.message.content,
                            data.senderAvatar || '/img/logo.jpg',
                            { senderId: data.senderId }
                        );
                    }
                });

                // Listen for unread messages by friend
                notificationHubConnection.on("ReceiveUnreadMessagesByFriend", function(unreadSummary) {
                    console.log("[Index] UnreadMessagesByFriend:", unreadSummary);
                    updateFriendsWithUnreadBadges(unreadSummary);
                });
            }

            // Update unread badge on friends icon
            function updateUnreadBadge(count) {
                // Update badge in navigation if exists
                const badge = $('#friendsUnreadBadge');
                if (badge.length) {
                    if (count > 0) {
                        badge.removeClass('hidden').text(count > 99 ? '99+' : count);
                    } else {
                        badge.addClass('hidden');
                    }
                }
                
                // Update page title
                if (count > 0) {
                    document.title = `(${count}) OkeanChat`;
                } else {
                    document.title = 'OkeanChat';
                }
            }

            // Update unread badge on specific friend item
            function updateFriendUnreadBadge(friendId, unreadCount) {
                const friendItem = $(`.friend-item[data-friend-id="${friendId}"]`);
                if (friendItem.length === 0) return;

                let badge = friendItem.find('.unread-badge');
                if (badge.length === 0) {
                    // Create badge if doesn't exist
                    badge = $('<span>').addClass('unread-badge bg-red-500 text-white text-xs font-bold rounded-full px-2 py-0.5 ml-2');
                    friendItem.find('.flex.items-center.flex-1').append(badge);
                }

                if (unreadCount > 0) {
                    badge.removeClass('hidden').text(unreadCount > 99 ? '99+' : unreadCount);
                    friendItem.addClass('bg-gray-700'); // Highlight friend with unread
                } else {
                    badge.addClass('hidden');
                    friendItem.removeClass('bg-gray-700');
                }
            }

            // Update all friends with unread badges
            function updateFriendsWithUnreadBadges(unreadSummary) {
                let totalUnread = 0;
                
                if (unreadSummary && Array.isArray(unreadSummary)) {
                    unreadSummary.forEach(function(item) {
                        const friendId = item.friendId;
                        const unreadCount = item.unreadCount || 0;
                        if (friendId) {
                            updateFriendUnreadBadge(friendId, unreadCount);
                            totalUnread += unreadCount;
                        }
                    });
                }

                updateUnreadBadge(totalUnread);
            }

            // Update friend online status in UI
            function updateFriendOnlineStatus(userId, isOnline) {
                const friendItem = $(`.friend-item[data-friend-id="${userId}"]`);
                if (friendItem.length === 0) return;

                const statusIndicator = friendItem.find('.friend-status-indicator');
                const statusText = friendItem.find('.friend-status-text');

                if (isOnline) {
                    statusIndicator.removeClass('bg-gray-500').addClass('bg-green-500');
                    statusText.removeClass('text-gray-500').addClass('text-green-400').text('Online');
                } else {
                    statusIndicator.removeClass('bg-green-500').addClass('bg-gray-500');
                    statusText.removeClass('text-green-400').addClass('text-gray-500').text('Offline');
                }
            }

            $(document).ready(function() {
                // Initialize SignalR
                if (currentUserId) {
                    initializeSignalR();
                    initializeNotificationHub();
                    
                    // Load initial unread count
                    $.get('/api/Friend/unread-count')
                        .done(function(data) {
                            updateUnreadBadge(data.unreadCount);
                        });
                }
                // Close sidebar when clicking a link on mobile (using global functions)
                $('#sidebar a[href]').on('click', function() {
                    if ($(window).width() < 1024 && window.closeSidebar) {
                        window.closeSidebar();
                    }
                });
                
                // Show add channel modal
                $('#addChannelBtn').click(function() {
                    $('#addChannelModal').modal('show');
                });

                // Create channel
                $('#createChannelBtn').click(function() {
                    const name = $('#channelName').val();
                    const description = $('#channelDescription').val();

                    if (!name.trim()) {
                        alert('Channel name is required');
                        return;
                    }

                    $.post('@Url.Action("CreateChannel", "Home")', {
                        name: name,
                        description: description
                    }, function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    });
                });

                // Friend Functions
                if (currentUserId) {
                    loadFriends();
                    loadFriendRequests();

                    // Search friends
                    $('#searchFriendInput').on('input', function() {
                        const query = $(this).val().trim();
                        if (query.length < 3) {
                            $('#searchResults').addClass('hidden').empty();
                            return;
                        }

                        clearTimeout(friendSearchTimer);
                        friendSearchTimer = setTimeout(() => {
                            searchUsers(query);
                        }, 500);
                    });

                    // Add friend button
                    $('#addFriendBtn').click(function() {
                        $('#searchFriendInput').focus();
                    });

                    // Friend requests button
                    $('#friendRequestsBtn, #friendRequestsIconBtn').click(function() {
                        showFriendRequestsModal();
                    });
                    
                    // Update friend requests icon badge - make it global
                    window.updateFriendRequestsIconBadge = function(count) {
                        const iconBadge = $('#friendRequestsIconBadge');
                        const countSpan = $('#friendRequestsIconCount');
                        
                        if (!iconBadge.length) {
                            console.warn('Friend requests icon badge not found in DOM');
                            return;
                        }
                        
                        if (count > 0) {
                            iconBadge.removeClass('hidden');
                            if (countSpan.length) {
                                countSpan.text(count > 99 ? '99+' : count);
                            }
                        } else {
                            iconBadge.addClass('hidden');
                        }
                    };
                }
            });

            function searchUsers(username) {
                const searchResults = $('#searchResults');
                searchResults.removeClass('hidden').html(`
                    <div class="text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                        <p class="text-gray-400 text-xs mt-2">Searching...</p>
                    </div>
                `);
                
                $.get('/api/Friend/search', { username: username })
                    .done(function(users) {
                        searchResults.empty();

                        if (users.length === 0) {
                            searchResults.html(`
                                <div class="text-center py-4">
                                    <i class="fas fa-search text-gray-500 text-2xl mb-2"></i>
                                    <p class="text-gray-400 text-sm">No users found</p>
                                    <p class="text-gray-500 text-xs mt-1">Try a different username</p>
                                </div>
                            `);
                            return;
                        }

                        users.forEach(function(user) {
                            const userElement = createSearchUserElement(user);
                            searchResults.append(userElement);
                        });
                    })
                    .fail(function() {
                        searchResults.html(`
                            <div class="text-center py-4">
                                <p class="text-red-400 text-sm">Failed to search users</p>
                            </div>
                        `);
                    });
            }

            function createSearchUserElement(user) {
                const div = $('<div>')
                    .addClass('flex items-center justify-between p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition-all duration-200')
                    .attr('data-user-id', user.id);
                
                const userInfo = $('<div>').addClass('flex items-center flex-1');
                const avatar = $('<div>').addClass('w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3 overflow-hidden flex-shrink-0 shadow-md');
                
                if (user.avatar) {
                    avatar.html(`<img src="${user.avatar}" alt="${user.displayName}" class="w-10 h-10 rounded-full object-cover">`);
                } else {
                    avatar.html(`<span class="text-sm font-semibold text-white">${user.displayName.charAt(0).toUpperCase()}</span>`);
                }
                
                const nameContainer = $('<div>').addClass('flex flex-col');
                const name = $('<span>').addClass('text-white text-sm font-medium').text(user.displayName);
                const userNameText = user.userName || '';
                const usernameSpan = $('<span>').addClass('text-gray-400 text-xs');
                usernameSpan.text('@@' + userNameText);
                nameContainer.append(name).append(usernameSpan);
                
                userInfo.append(avatar).append(nameContainer);
                
                // Check friendship status
                const friendshipStatus = user.friendshipStatus;
                let actionBtn;
                
                if (friendshipStatus && friendshipStatus.status === 'Pending') {
                    if (friendshipStatus.isRequester) {
                        // User sent request, show "Added" button (Facebook style - can cancel)
                        actionBtn = $('<button>')
                            .addClass('added-friend-btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-xs transition-all hover:bg-gray-700 flex items-center space-x-2 font-medium')
                            .html('<i class="fas fa-check"></i><span>Added</span>')
                            .attr('data-user-id', user.id)
                            .attr('data-friendship-id', friendshipStatus.friendshipId)
                            .click(function() {
                                cancelFriendRequest(user.id);
                            });
                    } else {
                        // User received request, show Respond button
                        actionBtn = $('<button>')
                            .addClass('bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs transition-all hover:scale-105 flex items-center space-x-1')
                            .html('<i class="fas fa-reply"></i><span>Respond</span>')
                            .click(function() {
                                showFriendRequestsModal();
                            });
                    }
                } else if (friendshipStatus && friendshipStatus.status === 'Accepted') {
                    // Already friends
                    actionBtn = $('<span>')
                        .addClass('bg-green-600 text-white px-4 py-2 rounded-lg text-xs flex items-center space-x-1')
                        .html('<i class="fas fa-check-circle"></i><span>Friends</span>');
                } else {
                    // No request, show Add Friend button (Facebook style)
                    actionBtn = $('<button>')
                        .addClass('add-friend-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs transition-all hover:scale-105 flex items-center space-x-2 font-medium')
                        .html('<i class="fas fa-user-plus"></i><span>Add Friend</span>')
                        .attr('data-user-id', user.id)
                        .click(function() {
                            sendFriendRequest(user.id);
                        });
                }
                
                div.append(userInfo).append(actionBtn);
                return div;
            }

            function sendFriendRequest(userId) {
                const btn = $(`#searchResults [data-user-id="${userId}"]`).find('.add-friend-btn');
                if (btn.length === 0) {
                    console.error('Add friend button not found for user:', userId);
                    return;
                }
                
                if (!userId || userId.trim() === '') {
                    showNotification('Invalid user ID', 'error');
                    return;
                }
                
                const originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: '/api/Friend/request',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ userId: userId }),
                    success: function(response) {
                        // Change to "Added" button (Facebook style)
                        btn.removeClass('add-friend-btn bg-blue-600 hover:bg-blue-700')
                            .addClass('added-friend-btn bg-gray-600 hover:bg-gray-700')
                            .html('<i class="fas fa-check"></i><span>Added</span>')
                            .off('click')
                            .click(function() {
                                cancelFriendRequest(userId);
                            });
                        btn.prop('disabled', false);
                        
                        showNotification('Friend request sent!', 'success');
                        loadFriendRequests();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error sending friend request:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        let errorMessage = 'Failed to send friend request';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.status === 401) {
                            errorMessage = 'Please log in to send friend requests';
                        } else if (xhr.status === 404) {
                            errorMessage = 'User not found';
                        } else if (xhr.status === 400) {
                            errorMessage = xhr.responseText || 'Invalid request';
                        }
                        
                        showNotification(errorMessage, 'error');
                        btn.prop('disabled', false).html(originalHtml);
                    }
                });
            }

            function cancelFriendRequest(userId) {
                const btn = $(`#searchResults [data-user-id="${userId}"]`).find('.added-friend-btn');
                if (btn.length === 0) {
                    console.error('Cancel friend button not found for user:', userId);
                    return;
                }
                
                const originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: '/api/Friend/cancel',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ userId: userId }),
                    success: function(response) {
                        // Change back to "Add Friend" button
                        btn.removeClass('added-friend-btn bg-gray-600 hover:bg-gray-700')
                            .addClass('add-friend-btn bg-blue-600 hover:bg-blue-700')
                            .html('<i class="fas fa-user-plus"></i><span>Add Friend</span>')
                            .off('click')
                            .click(function() {
                                sendFriendRequest(userId);
                            });
                        btn.prop('disabled', false);
                        
                        showNotification('Friend request cancelled', 'success');
                        loadFriendRequests();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error cancelling friend request:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        let errorMessage = 'Failed to cancel friend request';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        
                        showNotification(errorMessage, 'error');
                        btn.prop('disabled', false).html(originalHtml);
                    }
                });
            }

            function updateSearchUserButton(userId, status) {
                const userDiv = $(`#searchResults [data-user-id="${userId}"]`);
                if (userDiv.length === 0) return;

                const actionBtn = userDiv.find('.add-friend-btn, .added-friend-btn');
                if (actionBtn.length === 0) return;
                
                if (status === 'sent') {
                    // Change to "Added" button (Facebook style)
                    actionBtn.removeClass('add-friend-btn bg-blue-600 hover:bg-blue-700')
                            .addClass('added-friend-btn bg-gray-600 hover:bg-gray-700')
                            .html('<i class="fas fa-check"></i><span>Added</span>')
                            .off('click')
                            .click(function() {
                                cancelFriendRequest(userId);
                            });
                } else if (status === 'none') {
                    // Change back to "Add Friend" button
                    actionBtn.removeClass('added-friend-btn bg-gray-600 hover:bg-gray-700')
                            .addClass('add-friend-btn bg-blue-600 hover:bg-blue-700')
                            .html('<i class="fas fa-user-plus"></i><span>Add Friend</span>')
                            .off('click')
                            .click(function() {
                                sendFriendRequest(userId);
                            });
                }
            }

            function loadFriends() {
                $.get('/api/Friend/list')
                    .done(function(friendships) {
                        const friendsList = $('#friendsList');
                        
                        if (friendships.length === 0) {
                            friendsList.html(`
                                <div class="text-center py-8">
                                    <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i class="fas fa-user-friends text-gray-500 text-2xl"></i>
                                    </div>
                                    <p class="text-gray-400 text-sm mb-2">No friends yet</p>
                                    <p class="text-gray-500 text-xs">Search for users to add them as friends</p>
                                </div>
                            `);
                            $('#friendsListFilter').addClass('hidden');
                            return;
                        }

                        friendsList.empty();
                        $('#friendsListFilter').removeClass('hidden');
                        
                        // Sort friends alphabetically
                        friendships.sort((a, b) => {
                            const nameA = (a.friend.displayName || a.friend.userName).toLowerCase();
                            const nameB = (b.friend.displayName || b.friend.userName).toLowerCase();
                            return nameA.localeCompare(nameB);
                        });

                        friendships.forEach(function(friendship) {
                            const friendElement = createFriendElement(friendship.friend, friendship.friendshipId);
                            friendsList.append(friendElement);
                        });

                        // Request online status for all friends after loading
                        if (chatHubConnection && chatHubConnection.state === signalR.HubConnectionState.Connected) {
                            friendships.forEach(function(friendship) {
                                chatHubConnection.invoke("GetFriendOnlineStatus", friendship.friend.id).catch(function(err) {
                                    console.error("[Index] Error getting friend online status:", err);
                                });
                            });
                        }

                        // Load unread badges for friends
                        $.get('/api/Friend/unread-by-friend')
                            .done(function(unreadData) {
                                updateFriendsWithUnreadBadges(unreadData);
                            });
                    })
                    .fail(function() {
                        const friendsList = $('#friendsList');
                        friendsList.html(`
                            <div class="text-center py-4">
                                <p class="text-red-400 text-sm">Failed to load friends</p>
                                <button onclick="loadFriends()" class="text-blue-400 text-xs mt-2 hover:underline">Retry</button>
                            </div>
                        `);
                    });
            }

            function createFriendElement(friend, friendshipId) {
                const div = $('<div>')
                    .addClass('group flex items-center justify-between p-2 hover:bg-gray-700 rounded-lg cursor-pointer friend-item transition-all duration-200')
                    .attr('data-friend-id', friend.id)
                    .attr('data-friendship-id', friendshipId)
                    .attr('data-friend-name', friend.displayName.toLowerCase());
                
                const userInfo = $('<div>').addClass('flex items-center flex-1 min-w-0');
                const avatar = $('<div>').addClass('relative w-10 h-10 mr-3 flex-shrink-0');
                
                const avatarImg = $('<div>').addClass('w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center overflow-hidden shadow-md');
                if (friend.avatar) {
                    avatarImg.html(`<img src="${friend.avatar}" alt="${friend.displayName}" class="w-full h-full object-cover rounded-full">`);
                } else {
                    avatarImg.html(`<span class="text-sm font-semibold text-white">${friend.displayName.charAt(0).toUpperCase()}</span>`);
                }
                
                // Set initial online status from API response
                const isOnline = friend.isOnline === true || friend.isOnline === 'true';
                const onlineDotClass = isOnline ? 'bg-green-500' : 'bg-gray-500';
                const onlineDot = $('<div>').addClass(`absolute bottom-0 right-0 w-3 h-3 ${onlineDotClass} rounded-full border-2 border-gray-800 shadow-sm friend-status-indicator`);
                avatar.append(avatarImg).append(onlineDot);
                
                const nameContainer = $('<div>').addClass('flex flex-col min-w-0 flex-1');
                const name = $('<span>').addClass('text-white text-sm font-medium truncate').text(friend.displayName);
                const statusClass = isOnline ? 'text-green-400' : 'text-gray-500';
                const statusText = isOnline ? 'Online' : 'Offline';
                const status = $('<span>').addClass(`friend-status-text ${statusClass} text-xs`).text(statusText);
                nameContainer.append(name).append(status);
                
                userInfo.append(avatar).append(nameContainer);
                
                const actions = $('<div>').addClass('flex items-center space-x-1 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity');

                const chatBtn = $('<button>')
                    .addClass('bg-blue-600 hover:bg-blue-700 text-white px-2 py-1.5 rounded text-xs transition-all hover:scale-110')
                    .html('<i class="fas fa-comment"></i>')
                    .attr('title', 'Send message')
                    .click(function(e) {
                        e.stopPropagation();
                        window.location.href = '/Home/Chat?channelId=1&friendId=' + friend.id;
                    });

                const removeBtn = $('<button>')
                    .addClass('bg-red-600 hover:bg-red-700 text-white px-2 py-1.5 rounded text-xs transition-all hover:scale-110')
                    .html('<i class="fas fa-user-minus"></i>')
                    .attr('title', 'Remove friend')
                    .click(function(e) {
                        e.stopPropagation();
                        removeFriend(friendshipId, friend.displayName);
                    });

                // Only keep chat and remove buttons for friends list
                actions.append(chatBtn).append(removeBtn);
                div.append(userInfo).append(actions);
                
                // Click to open private chat
                div.click(function() {
                    window.location.href = '/Home/Chat?channelId=1&friendId=' + friend.id;
                });
                
                return div;
            }
            
            // Refresh friends button
            $('#refreshFriendsBtn').click(function() {
                $(this).addClass('animate-spin');
                loadFriends();
                setTimeout(() => {
                    $(this).removeClass('animate-spin');
                }, 1000);
            });
            
            // Filter friends
            $('.filter-btn').click(function() {
                $('.filter-btn').removeClass('active-filter bg-blue-600 text-white').addClass('bg-gray-700 text-gray-300');
                $(this).addClass('active-filter bg-blue-600 text-white').removeClass('bg-gray-700 text-gray-300');
                
                const filter = $(this).data('filter');
                filterFriends(filter);
            });
            
            function filterFriends(filter) {
                const friends = $('.friend-item');
                friends.each(function() {
                    if (filter === 'all') {
                        $(this).show();
                    } else if (filter === 'online') {
                        $(this).show();
                    }
                });
            }
            
            // Search in friends list
            let friendsSearchTimer = null;
            $('#searchFriendInput').on('input', function() {
                const query = $(this).val().trim().toLowerCase();
                
                clearTimeout(friendsSearchTimer);
                
                if (query.length === 0) {
                    $('.friend-item').show();
                    $('#searchResults').addClass('hidden');
                    return;
                }
                
                if (query.length < 2) {
                    return;
                }
                
                friendsSearchTimer = setTimeout(() => {
                    // Filter friends list
                    $('.friend-item').each(function() {
                        const friendName = $(this).attr('data-friend-name') || '';
                        if (friendName.includes(query)) {
                            $(this).show();
                        } else {
                            $(this).hide();
                        }
                    });
                    
                    // Also search for new users if query is 3+ characters
                    if (query.length >= 3) {
                        searchUsers(query);
                    } else {
                        $('#searchResults').addClass('hidden');
                    }
                }, 300);
            });
            
            function removeFriend(friendshipId, friendName) {
                if (!confirm(`Are you sure you want to remove ${friendName} from your friends list?`)) {
                    return;
                }
                
                $.post('/api/Friend/remove', { friendshipId: friendshipId })
                    .done(function() {
                        showNotification(`${friendName} has been removed from your friends list`, 'success');
                        loadFriends();
                    })
                    .fail(function(xhr) {
                        const error = xhr.responseJSON?.message || 'Failed to remove friend';
                        showNotification(error, 'error');
                    });
            }
            
            function showNotification(message, type) {
                const notification = $('<div>')
                    .addClass(`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full ${
                        type === 'success' ? 'bg-green-600' : 
                        type === 'error' ? 'bg-red-600' : 
                        'bg-blue-600'
                    } text-white max-w-sm`)
                    .html(`
                        <div class="flex items-center space-x-3">
                            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} text-xl"></i>
                            <span class="flex-1">${message}</span>
                            <button class="text-white hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `);
                
                $('body').append(notification);
                
                setTimeout(() => {
                    notification.removeClass('translate-x-full');
                }, 100);
                
                notification.find('button').click(function() {
                    notification.addClass('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                });
                
                setTimeout(() => {
                    notification.addClass('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            function loadFriendRequests() {
                $.get('/api/Friend/requests')
                    .done(function(requests) {
                        const count = requests ? requests.length : 0;
                        
                        if (count > 0) {
                            $('#friendRequestsCount').text(count);
                            $('#friendRequestsBadge').removeClass('hidden');
                        } else {
                            $('#friendRequestsBadge').addClass('hidden');
                        }
                        
                        // Update icon badge
                        if (typeof updateFriendRequestsIconBadge === 'function') {
                            updateFriendRequestsIconBadge(count);
                        } else {
                            // Fallback if function not yet defined
                            const iconBadge = $('#friendRequestsIconBadge');
                            const countSpan = $('#friendRequestsIconCount');
                            
                            if (count > 0) {
                                iconBadge.removeClass('hidden');
                                countSpan.text(count > 99 ? '99+' : count);
                            } else {
                                iconBadge.addClass('hidden');
                            }
                        }
                    })
                    .fail(function(xhr) {
                        console.error('Failed to load friend requests:', xhr);
                        // Still try to update badge to hidden
                        $('#friendRequestsIconBadge').addClass('hidden');
                    });
            }

            function showFriendRequestsModal() {
                $.get('/api/Friend/requests')
                    .done(function(requests) {
                        const modal = $('#friendRequestsModal');
                        const list = $('#friendRequestsList');
                        const count = $('#friendRequestsModalCount');
                        
                        list.empty();
                        if (count.length) {
                            count.text(requests.length + ' pending');
                        }

                        if (requests.length === 0) {
                            list.html(`
                                <div class="text-center py-12">
                                    <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-inbox text-gray-500 text-2xl"></i>
                                    </div>
                                    <p class="text-gray-400 text-sm mb-1">No friend requests</p>
                                    <p class="text-gray-500 text-xs">When someone sends you a friend request, it will appear here</p>
                                </div>
                            `);
                        } else {
                            requests.forEach(function(request) {
                                const item = createFriendRequestElement(request);
                                list.append(item);
                            });
                        }

                        modal.removeClass('hidden');
                    })
                    .fail(function() {
                        showNotification('Failed to load friend requests', 'error');
                    });
            }

            function createFriendRequestElement(request) {
                const div = $('<div>')
                    .addClass('bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition-all duration-200')
                    .attr('data-friendship-id', request.friendshipId);
                
                const userInfo = $('<div>').addClass('flex items-center mb-4');
                const avatar = $('<div>').addClass('w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3 overflow-hidden flex-shrink-0 shadow-md');
                
                if (request.requester.avatar) {
                    avatar.html(`<img src="${request.requester.avatar}" alt="${request.requester.displayName}" class="w-12 h-12 rounded-full object-cover">`);
                } else {
                    const firstLetter = request.requester.displayName.charAt(0).toUpperCase();
                    avatar.html(`<span class="text-base font-semibold text-white">${firstLetter}</span>`);
                }
                
                const info = $('<div>').addClass('flex-1 min-w-0');
                const name = $('<p>').addClass('text-white font-medium text-sm truncate').text(request.requester.displayName);
                const dateText = getTimeAgo(new Date(request.createdAt));
                const date = $('<p>').addClass('text-gray-400 text-xs mt-1').text(dateText);
                info.append(name).append(date);
                
                userInfo.append(avatar).append(info);
                
                const actions = $('<div>').addClass('flex space-x-2');
                const acceptBtn = $('<button>')
                    .addClass('flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-all hover:scale-105 flex items-center justify-center space-x-2')
                    .html('<i class="fas fa-check"></i><span>Accept</span>')
                    .click(function() {
                        acceptFriendRequest(request.friendshipId);
                    });
                
                const rejectBtn = $('<button>')
                    .addClass('flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition-all hover:scale-105 flex items-center justify-center space-x-2')
                    .html('<i class="fas fa-times"></i><span>Reject</span>')
                    .click(function() {
                        rejectFriendRequest(request.friendshipId);
                    });
                
                actions.append(acceptBtn).append(rejectBtn);
                div.append(userInfo).append(actions);
                
                return div;
            }
            
            function getTimeAgo(date) {
                const now = new Date();
                const diff = now - date;
                const seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                
                if (days > 0) return days + ' day' + (days > 1 ? 's' : '') + ' ago';
                if (hours > 0) return hours + ' hour' + (hours > 1 ? 's' : '') + ' ago';
                if (minutes > 0) return minutes + ' minute' + (minutes > 1 ? 's' : '') + ' ago';
                return 'Just now';
            }

            function acceptFriendRequest(friendshipId) {
                const btn = $(`[data-friendship-id="${friendshipId}"]`).find('button');
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: '/api/Friend/accept',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ friendshipId: friendshipId }),
                    success: function(response) {
                        showNotification('Friend request accepted! You are now friends!', 'success');
                        
                        // Remove the request from modal with animation
                        const requestElement = $(`[data-friendship-id="${friendshipId}"]`).closest('.bg-gray-700');
                        if (requestElement.length) {
                            requestElement.fadeOut(300, function() {
                                $(this).remove();
                                
                                // Check if there are any more requests
                                const remainingRequests = $('#friendRequestsList').children().length;
                                if (remainingRequests === 0) {
                                    // Close modal if no more requests
                                    setTimeout(function() {
                                        $('#friendRequestsModal').addClass('hidden');
                                    }, 100);
                                }
                            });
                        } else {
                            // Fallback: remove by data attribute
                            $(`[data-friendship-id="${friendshipId}"]`).parent().fadeOut(300, function() {
                                $(this).remove();
                                const remainingRequests = $('#friendRequestsList').children().length;
                                if (remainingRequests === 0) {
                                    setTimeout(function() {
                                        $('#friendRequestsModal').addClass('hidden');
                                    }, 100);
                                }
                            });
                        }
                        
                        // Reload friends list to show the new friend
                        loadFriends();
                        
                        // Reload friend requests to update badge
                        setTimeout(function() {
                            loadFriendRequests();
                        }, 500);
                    },
                    error: function(xhr) {
                        console.error('Error accepting friend request:', xhr);
                        const error = xhr.responseJSON?.message || 'Failed to accept friend request';
                        showNotification(error, 'error');
                        btn.prop('disabled', false).html('<i class="fas fa-check"></i><span>Accept</span>');
                    }
                });
            }

            function rejectFriendRequest(friendshipId) {
                const btn = $(`[data-friendship-id="${friendshipId}"]`).find('button');
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: '/api/Friend/reject',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ friendshipId: friendshipId }),
                    success: function(response) {
                        showNotification('Friend request rejected', 'success');
                        
                        // Remove the request from modal with animation
                        const requestElement = $(`[data-friendship-id="${friendshipId}"]`).closest('.bg-gray-700');
                        if (requestElement.length) {
                            requestElement.fadeOut(300, function() {
                                $(this).remove();
                                
                                // Check if there are any more requests
                                const remainingRequests = $('#friendRequestsList').children().length;
                                if (remainingRequests === 0) {
                                    // Close modal if no more requests
                                    setTimeout(function() {
                                        $('#friendRequestsModal').addClass('hidden');
                                    }, 100);
                                }
                            });
                        } else {
                            // Fallback: remove by data attribute
                            $(`[data-friendship-id="${friendshipId}"]`).parent().fadeOut(300, function() {
                                $(this).remove();
                                const remainingRequests = $('#friendRequestsList').children().length;
                                if (remainingRequests === 0) {
                                    setTimeout(function() {
                                        $('#friendRequestsModal').addClass('hidden');
                                    }, 100);
                                }
                            });
                        }
                        
                        // Reload friend requests to update badge
                        setTimeout(function() {
                            loadFriendRequests();
                        }, 500);
                    },
                    error: function(xhr) {
                        console.error('Error rejecting friend request:', xhr);
                        const error = xhr.responseJSON?.message || 'Failed to reject friend request';
                        showNotification(error, 'error');
                        btn.prop('disabled', false).html('<i class="fas fa-times"></i><span>Reject</span>');
                    }
                });
            }
            
        </script>

        <!-- Friend Requests Modal -->
        <div id="friendRequestsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
            <div class="bg-gray-800 rounded-lg shadow-2xl max-w-md w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b border-gray-700">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-yellow-600 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user-clock text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white">Friend Requests</h3>
                            <p class="text-xs text-gray-400" id="friendRequestsModalCount">0 pending</p>
                        </div>
                    </div>
                    <button id="closeFriendRequestsModal" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-gray-700 rounded">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <!-- Modal Body -->
                <div id="friendRequestsList" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- Friend requests will be populated here -->
                </div>
                <!-- Modal Footer -->
                <div class="p-4 border-t border-gray-700 text-center">
                    <button id="closeFriendRequestsModal2" class="text-gray-400 hover:text-white text-sm transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Incoming Call Modal -->
        <div id="incomingCallModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
            <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4 shadow-2xl">
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-phone text-white text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">Incoming Call</h3>
                    <p class="text-gray-300 mb-1" id="callerName">Unknown</p>
                    <p class="text-sm text-gray-400 mb-6" id="callType">Audio Call</p>
                    
                    <div class="flex space-x-4 justify-center">
                        <button class="reject-call-btn bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg flex items-center transition-all hover:scale-105">
                            <i class="fas fa-phone-slash mr-2"></i>
                            Reject
                        </button>
                        <button class="accept-call-btn bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center transition-all hover:scale-105">
                            <i class="fas fa-phone mr-2"></i>
                            Accept
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Call Interface -->
        <div id="callInterface" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
            <div class="w-full h-full max-w-4xl max-h-screen p-4">
                <div class="relative w-full h-full bg-gray-900 rounded-lg overflow-hidden">
                    <!-- Remote Video -->
                    <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                    
                    <!-- Local Video (for video calls) -->
                    <video id="localVideo" autoplay playsinline muted class="absolute top-4 right-4 w-48 h-36 object-cover rounded-lg border-2 border-white shadow-lg"></video>
                    
                    <!-- Call Controls -->
                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-4">
                        <button class="end-call-btn bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-full flex items-center transition-all hover:scale-110 shadow-lg">
                            <i class="fas fa-phone-slash text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Call Info -->
                    <div class="absolute top-4 left-4 bg-black bg-opacity-50 rounded-lg p-4">
                        <h3 class="text-white font-semibold" id="callInfo">Call in progress...</h3>
                    </div>
                </div>
            </div>
        </div>
    }
}