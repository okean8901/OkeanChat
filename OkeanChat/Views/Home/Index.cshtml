@using Microsoft.AspNetCore.Identity
@inject UserManager<OkeanChat.Models.ApplicationUser> UserManager
@{
    ViewData["Title"] = "OkeanChat - Discord-like Chat";
}

<div class="min-h-screen bg-gray-900 flex">
    <!-- Sidebar -->
    <div class="w-64 bg-gray-800 flex flex-col">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center">
                <img src="~/img/logo.jpg" alt="OkeanChat Logo" class="w-10 h-10 rounded mr-3" />
                <h1 class="text-xl font-bold text-white">OkeanChat</h1>
            </div>
        </div>

        <!-- Channels -->
        <div class="flex-1 p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Channels</h2>
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <button id="addChannelBtn" class="text-gray-400 hover:text-white">
                        <i class="fas fa-plus"></i>
                    </button>
                }
            </div>
            
            <div class="space-y-1">
                @if (ViewBag.Channels != null)
                {
                    @foreach (var channel in ViewBag.Channels as List<OkeanChat.Models.Channel>)
                    {
                        <a href="@Url.Action("Chat", "Home", new { channelId = channel.Id })" 
                           class="flex items-center px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-md group">
                            <i class="fas fa-hashtag text-gray-500 mr-2 group-hover:text-gray-300"></i>
                            @channel.Name
                        </a>
                    }
                }
            </div>
        </div>

        <!-- User Info -->
        <div class="p-4 border-t border-gray-700">
            @if (User.Identity?.IsAuthenticated == true)
            {
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center overflow-hidden avatar-container avatar-bordered" style="--avatar-size: 32px;">
                        @{
                            var user = await UserManager.GetUserAsync(User);
                            if (user != null && !string.IsNullOrEmpty(user.Avatar))
                            {
                                <img id="navAvatarIndex" src="@user.Avatar" alt="@user.DisplayName" class="nav-avatar avatar-perfect-circle force-circle">
                            }
                            else
                            {
                                <span class="text-sm font-semibold text-white">@User.Identity.Name?.Substring(0, 1).ToUpper()</span>
                            }
                        }
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-white">@User.Identity.Name</p>
                        <p class="text-xs text-gray-400">Online</p>
                    </div>
                </div>
                <div class="mt-2 space-y-1">
                    <a asp-action="Profile" asp-controller="Account" class="block text-xs text-gray-400 hover:text-white">Profile</a>
                    <form asp-action="Logout" asp-controller="Account" method="post" class="inline">
                        <button type="submit" class="text-xs text-gray-400 hover:text-white">Sign Out</button>
                    </form>
                </div>
            }
            else
            {
                <div class="space-y-2">
                    <a asp-action="Login" asp-controller="Account" class="block w-full py-2 px-3 text-sm text-center bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Sign In
                    </a>
                    <a asp-action="Register" asp-controller="Account" class="block w-full py-2 px-3 text-sm text-center bg-gray-700 text-white rounded-md hover:bg-gray-600">
                        Sign Up
                    </a>
                </div>
            }
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <!-- Welcome Message -->
        <div class="flex-1 flex items-center justify-center bg-gray-900">
            <div class="text-center">
                <div class="w-32 h-32 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6 p-4">
                    <img src="~/img/logo.jpg" alt="OkeanChat Logo" class="w-full h-full object-contain rounded-full" />
                </div>
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <h2 class="text-3xl font-bold text-white mb-4">Welcome back, @User.Identity.Name!</h2>
                    <p class="text-gray-400 text-lg mb-8">Select a channel from the sidebar to start chatting</p>
                }
                else
                {
                    <h2 class="text-3xl font-bold text-white mb-4">Welcome to OkeanChat</h2>
                    <p class="text-gray-400 text-lg mb-8">Sign in to start chatting with your friends</p>
                }
                <div class="space-y-2">
                    @if (ViewBag.Channels != null)
                    {
                        @foreach (var channel in ViewBag.Channels as List<OkeanChat.Models.Channel>)
                        {
                            <a href="@Url.Action("Chat", "Home", new { channelId = channel.Id })" 
                               class="block px-6 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-hashtag mr-2"></i># @channel.Name
                            </a>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (User.Identity?.IsAuthenticated == true)
{
    <!-- Add Channel Modal -->
    <div class="modal fade" id="addChannelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-gray-800 text-white">
                <div class="modal-header border-gray-700">
                    <h5 class="modal-title">Create New Channel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addChannelForm">
                        <div class="mb-3">
                            <label for="channelName" class="form-label">Channel Name</label>
                            <input type="text" class="form-control bg-gray-700 border-gray-600 text-white" 
                                   id="channelName" name="name" placeholder="e.g., general" required>
                        </div>
                        <div class="mb-3">
                            <label for="channelDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control bg-gray-700 border-gray-600 text-white" 
                                      id="channelDescription" name="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-gray-700">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createChannelBtn">Create Channel</button>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            $(document).ready(function() {
                // Show add channel modal
                $('#addChannelBtn').click(function() {
                    $('#addChannelModal').modal('show');
                });

                // Create channel
                $('#createChannelBtn').click(function() {
                    const name = $('#channelName').val();
                    const description = $('#channelDescription').val();

                    if (!name.trim()) {
                        alert('Channel name is required');
                        return;
                    }

                    $.post('@Url.Action("CreateChannel", "Home")', {
                        name: name,
                        description: description
                    }, function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    });
                });
            });
        </script>
    }
}